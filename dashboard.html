<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio de Setores</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  
  <!-- Seu CSS -->
  <link rel="stylesheet" href="/style/styles.css" />
  
  <!-- Favicons -->
  <link rel="icon" href="/img/icon-png.png" type="image/png" />
  <link rel="icon" href="/img/icon-png.png" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/img/icon-png.png" />
  <link rel="icon" sizes="192x192" href="/img/icon-png.png" />
</head>
<body onload="verificarPermissoes()">

<body>
  
  <h3>
  
  <button id="addSetorBtn" class="operador-only" onclick="addSetor()">Adicionar Setor ‚ûï</button>
  </h3>
  <header class="navbar">
    <h1>
      <img src="/img/icon-png.png" alt="√çcone" class="navbar-icon" /> Invent√°rio de Setores
    </h1>
    
    <!-- Bot√£o do Menu Hamburguer -->
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    
    <!-- Navega√ß√£o -->
    <nav class="nav-links">
      <!-- Filtro de pesquisa -->
      <input
        type="text"
        id="searchInput"
        onkeyup="filterMachines()"
        placeholder="Pesquisar m√°quinas..."
        aria-label="Pesquisar m√°quinas"
      />
      
      <!-- Menu do usu√°rio -->
   <div class="user-menu user-name" onclick="toggleUserMenu(event)" style="cursor:pointer;">
  <img src="/img/avatar.webp" alt="Avatar do usu√°rio" class="user-avatar" id="userAvatar" />
  <span id="userName">Usu√°rio</span>




        
        <div class="user-dropdown" id="userDropdown" hidden>
          <button onclick="openConfigModal()">Configura√ß√µes ‚öôÔ∏è</button>
          
          <div class="box-switch">
            <h3>Alterar Layout</h3>
            <label class="switch">
             <input type="checkbox" id="layoutToggle" onchange="toggleLayout()" />

              <span class="slider"></span>
            </label>
          </div>
 

        <div id="adminMenu" style="display: none;">
  <button onclick="abrirPaginaUsuarios()">üë• Gest√£o de Usu√°rios</button>
</div>





<button onclick="excluirTodosSetores()" class="excluir-tudo-btn admin-only">
  üß® Excluir Todos os Setores
</button>

<button class="logout-btn" onclick="logout(this)">
  <span>Logout</span>
</button>
</div>
</div>
</nav>
</header>






<!-- Modal de Adicionar Setor -->
<div id="modalSetor" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="fecharModalSetor()" aria-label="Fechar">&times;</span>
    <h2>Adicionar Setor</h2>
    <input type="text" id="inputSetorNome" placeholder="Digite o nome do setor" />
    <button onclick="confirmarAddSetor()">Adicionar</button>
  </div>
</div>




<!-- Container dos setores -->
<main id="setoresContainer" class="list-view">
  <!-- Setores e m√°quinas ser√£o inseridos dinamicamente aqui -->
</main>
  
<!-- MODAL: Informa√ß√µes da M√°quina -->
<!-- Modal de Informa√ß√µes da M√°quina -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()" aria-label="Fechar">&times;</button>
    <h2>Informa√ß√µes da M√°quina</h2>
    <p id="modalText"></p>
    
    
    
    
    
    <!-- ...restante do conte√∫do do modal -->
    
    
    <section id="maintenanceSection">
      <h3>Chamado (Observa√ß√£o)</h3>
      <textarea id="observacao" placeholder="Adicione um chamado para manuten√ß√£o..." rows="4"></textarea>
      
      <fieldset style="margin-top: 10px; border: 1px solid #ccc; padding: 10px;">
        <legend style="cursor: pointer; user-select: none;" onclick="toggleChecklist(this)">
          <strong>Checklist de Manuten√ß√£o Preventiva</strong> 
          <span class="arrow" style="float: right;">‚ñº</span>
        </legend>
        <div class="checklist-content">
          <label><input type="checkbox" name="checklist" value="funciona" /> Equipamento funcionando normalmente</label><br />
          <label><input type="checkbox" name="checklist" value="ligaReinicia" /> Liga e reinicia sem erros</label><br />
          <label><input type="checkbox" name="checklist" value="semBarulho" /> Sem barulhos estranhos</label><br />
          <label><input type="checkbox" name="checklist" value="temperaturaNormal" /> Temperatura normal (ao toque)</label><br />
          <label><input type="checkbox" name="checklist" value="equipamentoLimpo" /> Equipamento limpo (sem poeira vis√≠vel)</label><br />
        </div>
      </fieldset>
      
      
      <label for="priority" style="margin-top: 10px; display: block;">Prioridade:</label>
      <select id="priority">
        <option value="Baixa">Baixa</option>
          <option value="M√©dia">M√©dia</option>
          <option value="Alta">Alta</option>
        </select>
        
        <button style="margin-top: 10px;" onclick="saveObservation()">Salvar Chamado</button>
      </section>
      
      <section id="observationsList" style="margin-top: 20px;">
        <h3>Chamados Anteriores</h3>
        <ul
        id="observationsUl"
        style="max-height: 250px; overflow-y: auto; list-style: none; padding-left: 0;"
        ></ul>
      </section>
      
      <div
      id="maintenanceMessage"
      style="display: none; margin-top: 15px; color: rgb(221, 212, 212); font-weight: bold;border-radius: 10px;"
      >
      <p>A m√°quina foi marcada para manuten√ß√£o.</p>
    </div>
    
    <!-- Bot√µes de a√ß√£o -->
    <div class="modal-actions" style="margin-top: 20px;">
      <button id="maintenanceBtn" onclick="markForMaintenance()">Manuten√ß√£o</button>
        <button id="releaseBtn" onclick="releaseMachine()" style="display: none;">Liberar</button>
        <button id="close-btn" onclick="closeModal()"> Fechar</button>
        
      </div>
     
    </div>
  </div>
  
  <!-- Modal de Configura√ß√µes -->
  <div id="configModal" class="config-modal">
    <div class="config-modal-content">
      <button class="close-btn" onclick="closeConfigModal()" aria-label="Fechar">&times;</button>
      <h2>Configura√ß√µes</h2>
      
      <!-- Trocar foto do perfil -->
      <div class="profile-picture-section">
        <img src="/img/avatar.webp" alt="Foto de Perfil" id="profilePic" />
        <input
          type="file"
          id="profilePicInput"
          accept="image/*"
          onchange="changeProfilePicture(event)"
        />
        <label for="profilePicInput" class="upload-btn">Alterar Foto</label>
      </div>
      <h3>Backup / Restaura√ß√£o</h3>
<button onclick="exportarBackupJSON()">üì§ Exportar Backup (JSON)</button>
<button onclick="document.getElementById('jsonInput').click()">üì• Importar Backup (JSON)</button>
<input type="file" id="jsonInput" accept=".json" onchange="importarBackupJSON(event)" style="display:none;" />

  <h3> DADOS CSV</h3>
      <button onclick="importFromCSVButton()">Importar CSV</button>
      <button onclick="exportToCSV()">Exportar para CSV</button>
      <input type="file" id="csvInput" style="display: none;" onchange="importFromCSV(event)" />
      


      
      <button class="save-btn" onclick="closeConfigModal()">Salvar Configura√ß√µes</button>
    </div>
  </div>
  
  <!-- Modal Adicionar M√°quina/Monitor -->
 <div id="modalMaquina" class="modal" style="display: none;">
  <div class="modal-content">
    <h2>Adicionar M√°quina ou Monitor</h2>
    
    <label for="tipoEquipamento">Tipo:</label>
    <select id="tipoEquipamento" onchange="trocarCampos()">
      <option value="">Selecione</option>
      <option value="m√°quina">M√°quina</option>
      <option value="monitor">Monitor</option>
    </select>
    
    <div id="camposMaquina" style="display: none; margin-top: 10px;">
      <label for="tipoMaquina">Tipo de M√°quina:</label>
      <select id="tipoMaquina">
        <option value="">Selecione</option>
        <option value="Desktop">Desktop</option>
        <option value="Notebook">Notebook</option>
        <option value="Workstation">Workstation</option>
      </select>
      
      <label for="usuarioResponsavel" style="margin-top: 10px;">Usu√°rio:</label><br>
<input type="text" id="usuarioResponsavel" placeholder="Ex: Jo√£o Silva" /><br>
      <label for="nomeMaquina" style="margin-top: 10px;">N√∫mero de S√©rie:</label><br>
      <input type="text" id="nomeMaquina" placeholder="Ex: 12345ABC" /><br>
      
      <label for="etiquetaMaquina" style="margin-top: 10px;">Etiqueta:</label><br>
      <input type="text" id="etiquetaMaquina" placeholder="Ex: TI-001" />
      
      <button onclick="abrirScanner()">üì∑ Ler QR/Barra</button>
    </div>
    
    <div id="camposMonitor" style="display: none; margin-top: 10px;">
      <label for="etiquetaMonitor">Etiqueta do Monitor:</label>
      <input type="text" id="etiquetaMonitor" placeholder="Ex: MON-123" />
      <button onclick="abrirScanner()">üì∑ Ler QR/Barra</button>
    </div>
    
    <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="fecharModalMaquina()">Cancelar</button>
      <button onclick="confirmarAddMaquina()">Adicionar</button>
    </div>
  </div>
</div>
  
  <!-- Scanner Modal -->
  <div
    id="modalScanner"
    style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    "
  >
    <div style="background: white; padding: 20px; border-radius: 10px;">
      <h3>Escaneie o QR Code ou C√≥digo de Barras</h3>
      <div id="reader" style="width: 300px;"></div>
      <button onclick="fecharScanner()" style="margin-top: 10px;">Fechar</button>
    </div>
  </div>
  





  
  <!-- Scripts externos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  
  
  <!-- Seus scripts JS -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="/js/chamado.js"></script>
  <script src="/js/setores.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/index.js"></script>
  <script src="/js/csv.js"></script>
  <script src="/js/script.js"></script>



  <script>
   const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));

  if (!usuario) {
    alert("Acesso negado! Fa√ßa login primeiro.");
    window.location.href = "index.html";
  } else {
    document.getElementById("userName").textContent = usuario.nome;
    const perfil = usuario.perfil;

    if (perfil === "visualizador") {
      // Remove bot√µes de a√ß√£o do menu
      document.getElementById("addSetorBtn").style.display = "none";
      document.querySelector(".excluir-tudo-btn").style.display = "none";

      // Bloqueia fun√ß√µes de altera√ß√£o
      window.addSetor = () => {};
      window.confirmarAddSetor = () => {};
      window.confirmarAddMaquina = () => {};
      window.abrirScanner = () => {};
      window.saveObservation = () => {};
      window.markForMaintenance = () => {};
      window.releaseMachine = () => {};

      // Remove bot√£o de salvar chamado no modal
      const btnSalvar = document.querySelector('#observacao + select + button');
      if (btnSalvar) btnSalvar.remove();

      // Remove bot√µes de a√ß√£o no modal (se existirem)
      const btnManutencao = document.getElementById("maintenanceBtn");
      const btnLiberar = document.getElementById("releaseBtn");
      const btnFechar = document.getElementById("close-btn");

      if (btnManutencao) btnManutencao.remove();
      if (btnLiberar) btnLiberar.remove();

      // Impede exclus√£o de chamados
      const observer = new MutationObserver(() => {
        const botoesExcluir = document.querySelectorAll(".excluir-chamado");
        botoesExcluir.forEach(btn => btn.remove());
      });
      observer.observe(document.getElementById("observationsUl"), { childList: true, subtree: true });
    }

    if (perfil === "editor") {
      document.querySelector(".excluir-tudo-btn").style.display = "none";
      window.saveObservation = () => {};
      window.markForMaintenance = () => {};
      window.releaseMachine = () => {};
    }
  }

  function logout() {
    localStorage.removeItem("usuarioLogado");
    window.location.href = "index.html";
  }



</script>
  
<script type="module">
    function verificarPermissoes() {
      const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
      const adminMenu = document.getElementById("adminMenu");
      if (!usuario || !adminMenu) return;

      if (usuario.perfil === "admin" || usuario.perfil === "") {
        adminMenu.style.display = "block";
      } else {
        adminMenu.style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
      if (!usuarioLogado) {
        alert("Voc√™ precisa estar logado!");
        window.location.href = "index.html";
        return;
      }
      verificarPermissoes();

     
    });

  </script>



</body>
</html>
